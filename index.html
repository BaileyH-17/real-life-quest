<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Real Life Quest - ç”Ÿæ´»æ¸¸æˆåŒ–</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.294.0/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    
    <!-- PWAç›¸å…³é…ç½® -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Real Life Quest">
    
    <!-- iOSå›¾æ ‡ -->
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

    <style>
        /* å…¨å±€å­—ä½“è®¾ç½® */
        body { font-family: 'Inter', sans-serif; }
        
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ç®€å•çš„æ·¡å…¥åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        /* è¿›åº¦æ¡å…‰æ•ˆ */
        .xp-glow { box-shadow: 0 0 10px rgba(99, 102, 241, 0.6); }
        
        /* é€æ˜æ•ˆæœæ ·å¼ */
        .bg-transparent-white { background-color: rgba(255, 255, 255, 0.8); }
        .bg-transparent-white-hover { background-color: rgba(255, 255, 255, 0.9); }
        .bg-transparent-indigo { background-color: rgba(99, 102, 241, 0.1); }
        .bg-transparent-purple { background-color: rgba(139, 92, 246, 0.1); }
        .bg-transparent-green { background-color: rgba(34, 197, 94, 0.1); }
        
        /* å¡ç‰‡é˜´å½±å’Œé€æ˜æ•ˆæœ */
        .card-transparent { 
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .card-transparent-hover:hover {
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        /* æŒ‰é’®é€æ˜æ•ˆæœ */
        .btn-transparent {
            background-color: rgba(99, 102, 241, 0.9);
            backdrop-filter: blur(5px);
        }
        
        .btn-transparent:hover {
            background-color: rgba(99, 102, 241, 1);
        }
        
        /* æ¨¡æ€æ¡†é€æ˜æ•ˆæœ */
        .modal-backdrop-transparent {
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
        }
        
        /* ä¸Šä¸‹æ–‡èœå•æ ·å¼ */
        .context-menu {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15), 0 5px 10px rgba(0, 0, 0, 0.05);
        }
        
        /* æ¸å˜èƒŒæ™¯ */
        .bg-gradient-transparent {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        }
        
        /* æ‚¬åœç¼©æ”¾æ•ˆæœ */
        .hover-scale {
            transition: transform 0.3s ease;
        }
        
        .hover-scale:hover {
            transform: scale(1.02);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased selection:bg-indigo-100 selection:text-indigo-700">

    <div class="app-container min-h-screen max-w-md mx-auto bg-slate-50 relative shadow-2xl overflow-hidden min-h-screen border-x border-slate-100">
        
        <div class="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-indigo-50/50 to-transparent pointer-events-none"></div>

        <header class="sticky top-0 z-40 bg-white/80 backdrop-blur-md border-b border-slate-100 px-5 pt-4 pb-2 mb-4">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-600 text-white p-1.5 rounded-lg shadow-indigo-200 shadow-lg">
                        <i data-lucide="sword" class="w-5 h-5"></i>
                    </div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-900">Real Life Quest</h1>
                </div>
                <div class="flex items-center gap-2 bg-slate-100/80 px-3 py-1.5 rounded-full border border-slate-200">
                    <span class="text-amber-500 drop-shadow-sm">ğŸ†</span>
                    <span id="medalsDisplay" class="text-sm font-bold text-slate-700">0</span>
                </div>
            </div>
            
            <div class="xp-section mb-4">
                <div class="flex justify-between items-end text-xs mb-1.5 px-1">
                    <span class="text-slate-500 font-medium">å½“å‰ç­‰çº§è¿›åº¦</span>
                    <span id="xpDisplay" class="font-bold text-indigo-600">0 XP</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden border border-slate-200 shadow-inner">
                    <div id="xpProgress" class="xp-glow bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 h-full rounded-full transition-all duration-700 ease-out" style="width: 0%"></div>
                </div>
            </div>
            
            <nav class="nav-tabs grid grid-cols-3 gap-1 bg-slate-100/50 p-1 rounded-xl border border-slate-200/60">
                <button class="tab-btn text-xs font-semibold py-2.5 rounded-lg text-slate-500 hover:text-indigo-600 transition-all duration-200 flex justify-center items-center gap-1.5" data-tab="schedule">
                    <i data-lucide="calendar" class="w-4 h-4"></i> æ—¥ç¨‹
                </button>
                <button class="tab-btn active text-xs font-semibold py-2.5 rounded-lg bg-white text-indigo-600 shadow-sm border border-slate-100 transition-all duration-200 flex justify-center items-center gap-1.5" data-tab="quest">
                    <i data-lucide="map" class="w-4 h-4"></i> ä»»åŠ¡
                </button>
                <button class="tab-btn text-xs font-semibold py-2.5 rounded-lg text-slate-500 hover:text-indigo-600 transition-all duration-200 flex justify-center items-center gap-1.5" data-tab="profile">
                    <i data-lucide="user" class="w-4 h-4"></i> èµ„æ–™
                </button>
            </nav>
        </header>

        <main class="app-main px-4 pb-20 relative z-0">
            
            <section id="schedule" class="tab-content hidden animate-fade-in">
                <div class="calendar-container bg-white rounded-2xl shadow-sm border border-slate-100 p-5 mb-5">
                    <div class="calendar-header flex justify-between items-center mb-4">
                        <button class="calendar-nav p-2 hover:bg-slate-50 rounded-full text-slate-400 hover:text-indigo-600 transition-colors" onclick="changeMonth(-1)">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <h2 id="currentMonth" class="text-base font-bold text-slate-800"></h2>
                        <button class="calendar-nav p-2 hover:bg-slate-50 rounded-full text-slate-400 hover:text-indigo-600 transition-colors" onclick="changeMonth(1)">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="calendar-grid grid grid-cols-7 gap-y-3 gap-x-1 text-center text-sm" id="calendarGrid">
                    </div>
                </div>

                <div class="flex justify-between items-center mb-3 px-1">
                    <h2 class="text-lg font-bold text-slate-800">æ—¶é—´è½´</h2>
                    <button class="add-btn flex items-center gap-1 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded-full shadow-lg shadow-indigo-200 transition-all active:scale-95" onclick="openScheduleModal()">
                    <i data-lucide="plus" class="w-4 h-4"></i> æ·»åŠ æ—¥ç¨‹
                </button>
                </div>

                <div class="schedule-list space-y-3" id="scheduleList">
                    <div class="text-center py-10 text-slate-400 text-sm">
                        æš‚æ— æ—¥ç¨‹ï¼Œå»æ·»åŠ ä¸€ä¸ªå§ï¼
                     </div>
                </div>
            </section>

            <section id="quest" class="tab-content active animate-fade-in">
                <div class="section-header mb-4 px-1">
                    <h2 class="text-xl font-bold text-slate-900">ä»Šæ—¥å†’é™©</h2>
                    <p id="selectedDateDisplayQuest" class="text-sm text-slate-500 mt-0.5"></p>
                </div>
                
                <div class="bg-white/60 backdrop-blur-sm rounded-xl border border-slate-100 p-4 mb-6">
                    <h3 class="text-xs font-bold uppercase text-slate-400 tracking-wider mb-3">Context (ä»Šæ—¥æ—¥ç¨‹)</h3>
                    <div id="dailyScheduleList" class="daily-schedule-list space-y-2">
                        <p class="text-sm text-slate-500 italic">ç©ºç©ºå¦‚ä¹Ÿ...</p>
                    </div>
                </div>
                
                <div class="input-bubble bg-white rounded-2xl shadow-xl shadow-indigo-100/50 border border-indigo-50 p-6 relative overflow-hidden group">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-indigo-50 rounded-full opacity-50 group-hover:scale-150 transition-transform duration-700"></div>
                    
                    <div class="relative z-10 flex flex-col gap-4 text-center">
                        <div class="text-slate-600 text-sm font-medium">
                            <span class="inline-block text-2xl mb-2">ğŸ§™â€â™‚ï¸</span><br>
                            "å‘Šè¯‰æˆ‘ä»Šå¤©çš„å®‰æ’ï¼Œ<br>æˆ‘ä¸ºä½ ç”Ÿæˆä¸“å±æ”¯çº¿ä»»åŠ¡ã€‚"
                        </div>
                        <button class="generate-btn w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200 transition-all transform active:scale-[0.98] flex justify-center items-center gap-2" onclick="generateQuestsFromSchedule()">
                            <i data-lucide="sparkles" class="w-4 h-4"></i> å¼€å¯ä»Šæ—¥å†’é™©
                        </button>
                    </div>
                </div>

                <div class="current-quest-section mt-6" id="currentQuestSection" style="display: none;">
                    <div class="flex items-center gap-2 mb-3 px-1">
                        <span class="flex h-2 w-2 rounded-full bg-green-500"></span>
                        <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wide">è¿›è¡Œä¸­ä»»åŠ¡</h3>
                    </div>
                    <div class="current-quest" id="currentQuest">
                        </div>
                </div>
                
                <div class="quest-checkin-section mt-6 bg-white rounded-2xl shadow-sm border border-slate-100 p-5" id="questCheckinSection" style="display: none;">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="camera" class="w-5 h-5 text-indigo-500"></i> æäº¤å‡­è¯
                    </h3>
                    <form id="questCheckinForm" class="space-y-4">
                        <div>
                            <textarea id="checkinText" placeholder="æ­¤åˆ»çš„æ„Ÿå—..." rows="3" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all text-sm resize-none"></textarea>
                        </div>
                        <div class="relative">
                            <input type="file" id="checkinImage" accept="image/*" required class="w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition-all">
                        </div>
                        <button type="submit" class="complete-btn w-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-emerald-200 transition-all transform active:scale-[0.98]">
                            å®Œæˆä»»åŠ¡ (+XP)
                        </button>
                    </form>
                </div>
            </section>

            <section id="profile" class="tab-content hidden animate-fade-in">
                <div class="bg-indigo-600 rounded-2xl p-6 text-white shadow-xl shadow-indigo-200 mb-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full -mr-10 -mt-10"></div>
                    <div class="relative z-10 text-center">
                        <div class="w-20 h-20 bg-white/20 backdrop-blur-md rounded-full mx-auto mb-3 flex items-center justify-center text-3xl border-2 border-white/30">
                            ğŸ˜
                        </div>
                        <h2 class="text-xl font-bold mb-1">å‹‡è€… 001</h2>
                        <p class="text-indigo-200 text-sm">åˆçº§æ¢ç´¢è€…</p>
                    </div>
                </div>

                <div class="profile-stats grid grid-cols-3 gap-3 mb-6">
                <div class="bg-white rounded-2xl border border-slate-100 p-3 text-center shadow-sm">
                    <span class="block text-xs text-slate-400 mb-1">XP</span>
                    <span id="totalXpDisplay" class="text-xl font-bold text-indigo-600">0</span>
                </div>
                <div class="bg-white rounded-2xl border border-slate-100 p-3 text-center shadow-sm">
                    <span class="block text-xs text-slate-400 mb-1">å‹‹ç« </span>
                    <span id="totalMedalsDisplay" class="text-xl font-bold text-amber-500">0</span>
                </div>
                <div class="bg-white rounded-2xl border border-slate-100 p-3 text-center shadow-sm">
                    <span class="block text-xs text-slate-400 mb-1">ä»»åŠ¡</span>
                    <span id="completedQuestsDisplay" class="text-xl font-bold text-emerald-500">0</span>
                </div>
            </div>
            


                <div class="medals-section bg-white rounded-2xl border border-slate-100 p-5 shadow-sm">
                    <h3 class="text-base font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="award" class="w-4 h-4 text-amber-500"></i> å‹‹ç« å¢™
                    </h3>
                    <div class="medals-grid grid grid-cols-4 gap-3" id="medalsGrid">
                        </div>
                </div>
                
                <!-- è®¾ç½®æŒ‰é’® -->
                <button id="settingsBtn" class="mt-6 w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white text-sm font-medium py-3 px-6 rounded-xl shadow-lg shadow-indigo-200 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <i data-lucide="settings" class="w-4 h-4"></i> è®¾ç½®
                </button>
            </section>
        </main>
    </div>
    
    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="settingsModal" class="modal fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm relative z-10 overflow-hidden transform scale-95 opacity-0 transition-all duration-300">
            <div class="bg-indigo-600 p-6 text-white text-center relative overflow-hidden">
                <h3 class="text-xl font-bold">è®¾ç½®</h3>
                <button class="close absolute top-4 right-4 text-white/70 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-4">
                <!-- ç›´æ¥æ˜¾ç¤ºæ˜µç§°è¾“å…¥æ¡† -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-700">æ˜µç§°</label>
                    <input type="text" id="userName" placeholder="è¾“å…¥ä½ çš„æ˜µç§°" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all">
                </div>
                
                <!-- ç›´æ¥æ˜¾ç¤ºå¤´åƒä¸Šä¼ æ§ä»¶ -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-slate-700">å¤´åƒ</label>
                    <input type="file" id="avatarUpload" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-xl file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition-all">
                </div>
                
                <!-- ä¿å­˜æŒ‰é’® -->
                <button id="saveSettingsBtn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white text-sm font-medium py-4 px-6 rounded-xl shadow-lg shadow-indigo-200 transition-all active:scale-95">
                    ä¿å­˜è®¾ç½®
                </button>
                
                <!-- åˆå§‹åŒ–æ•°æ®æŒ‰é’® -->
                <button id="initSystemBtn" class="w-full bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 text-white text-sm font-medium py-4 px-6 rounded-xl shadow-lg shadow-red-200 transition-all active:scale-95">
                    åˆå§‹åŒ–æ•°æ®
                </button>
            </div>
        </div>
    </div>

    <div id="scheduleModal" class="modal fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
        <div class="absolute bottom-0 left-0 right-0 md:relative md:m-auto w-full md:max-w-md bg-white md:rounded-2xl rounded-t-2xl shadow-2xl transform transition-transform duration-300 translate-y-full md:translate-y-0 p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 id="scheduleModalTitle" class="text-lg font-bold text-slate-800">æ·»åŠ æ–°æ—¥ç¨‹</h3>
                <button class="close p-2 bg-slate-50 rounded-full hover:bg-slate-100 text-slate-500">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="scheduleForm" class="space-y-4">
                <input type="hidden" id="scheduleId">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">äº‹ä»¶åç§°</label>
                    <input type="text" id="scheduleTitle" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">æ—¥æœŸ</label>
                    <input type="date" id="scheduleDate" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                         <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">å¼€å§‹</label>
                         <input type="time" id="scheduleStartTime" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none">
                    </div>
                    <div>
                         <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5">ç»“æŸ</label>
                         <input type="time" id="scheduleEndTime" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl outline-none">
                    </div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" class="cancel-btn flex-1 py-3 rounded-xl font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 transition-colors">å–æ¶ˆ</button>
                    <button type="submit" class="save-btn flex-1 py-3 rounded-xl font-bold text-white bg-indigo-600 hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all transform active:scale-95">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="questSelectModal" class="modal fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg relative z-10 overflow-hidden transform scale-95 opacity-0 transition-all duration-300" id="questSelectContent">
            <div class="bg-indigo-600 p-6 text-white text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                <h3 class="text-2xl font-bold relative z-10">Choose Your Path</h3>
                <p class="text-indigo-100 text-sm mt-1 relative z-10">æ ¹æ®ä½ çš„çŠ¶æ€ï¼Œç³»ç»Ÿç”Ÿæˆäº†ä»¥ä¸‹åˆ†æ”¯</p>
                <button class="close absolute top-4 right-4 text-white/70 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="p-6">
                <div class="quest-select-options grid grid-cols-1 gap-4">
                    </div>
            </div>
        </div>
    </div>

    <script src="data/quests.js"></script>
    <script src="utils/analyzeAndRecommend.js"></script>
    <script src="utils/generateQuests.js"></script>
    <script src="script.js"></script>
    <!-- è‡ªå®šä¹‰é€šçŸ¥ç»„ä»¶ -->
    <div id="notification" class="fixed top-4 right-4 z-50 hidden transform transition-all duration-300 ease-out">
        <div class="bg-white rounded-2xl shadow-xl p-5 max-w-sm w-full border border-slate-100">
            <div class="flex items-start gap-3">
                <div id="notificationIcon" class="text-2xl"></div>
                <div class="flex-1">
                    <h3 id="notificationTitle" class="font-semibold text-slate-800 mb-1"></h3>
                    <p id="notificationMessage" class="text-sm text-slate-600"></p>
                </div>
                <button id="notificationClose" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ç¡®ä¿æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆåå†æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ– Lucide å›¾æ ‡
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // ç®€å•çš„ Tab åˆ‡æ¢é€»è¾‘ (ä¸ºäº†æ¼”ç¤ºæ•ˆæœ)
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active', 'bg-white', 'text-indigo-600', 'shadow-sm', 'border', 'border-slate-100'));
                    tabs.forEach(t => t.classList.add('text-slate-500'));
                    
                    tab.classList.add('active', 'bg-white', 'text-indigo-600', 'shadow-sm', 'border', 'border-slate-100');
                    tab.classList.remove('text-slate-500');
                    
                    const target = tab.dataset.tab;
                    contents.forEach(content => {
                        content.classList.add('hidden');
                        if(content.id === target) {
                            content.classList.remove('hidden');
                        }
                    });
                });
            });

            // ç®€å•çš„æ¨¡æ€æ¡†å…³é—­é€»è¾‘
            document.querySelectorAll('.close, .cancel-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modal = e.target.closest('.modal');
                    if (modal) {
                        modal.classList.add('hidden');
                        modal.classList.remove('flex');
                    }
                });
            });
            
            // åˆå§‹åŒ–é€šçŸ¥å…³é—­æŒ‰é’®
            const notificationClose = document.getElementById('notificationClose');
            if (notificationClose) {
                notificationClose.addEventListener('click', hideNotification);
            }
            
            // è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsModal = document.getElementById('settingsModal');
            const userNameInput = document.getElementById('userName');
            const avatarUpload = document.getElementById('avatarUpload');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const initSystemBtn = document.getElementById('initSystemBtn');
            
            if (settingsBtn && settingsModal) {
                // æ˜¾ç¤ºè®¾ç½®å¼¹çª—
                settingsBtn.addEventListener('click', function() {
                    // å¡«å……å½“å‰è®¾ç½®
                    if (userNameInput && typeof gameData !== 'undefined') {
                        userNameInput.value = gameData.userInfo?.name || 'å‹‡è€… 001';
                    }
                    
                    // æ˜¾ç¤ºè®¾ç½®å¼¹çª—
                    settingsModal.classList.remove('hidden');
                    settingsModal.classList.add('flex');
                    // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                    const modalContent = settingsModal.querySelector('.bg-white');
                    if (modalContent) {
                        setTimeout(() => {
                            modalContent.style.opacity = '1';
                            modalContent.style.transform = 'scale(1)';
                        }, 10);
                    }
                });
                
                // ä¿å­˜è®¾ç½®
                if (saveSettingsBtn && userNameInput) {
                    saveSettingsBtn.addEventListener('click', function() {
                        const newName = userNameInput.value.trim();
                        if (!newName) {
                            alert('è¯·è¾“å…¥æ˜µç§°');
                            return;
                        }
                        
                        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
                        if (typeof gameData !== 'undefined') {
                            gameData.userInfo = gameData.userInfo || {};
                            gameData.userInfo.name = newName;
                            
                            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                            localStorage.setItem('gameData', JSON.stringify(gameData));
                            
                            // æ›´æ–°æ˜¾ç¤º
                            const profileName = document.querySelector('.profile-stats + .bg-indigo-600 h2');
                            if (profileName) {
                                profileName.textContent = newName;
                            }
                            
                            // æ˜¾ç¤ºæˆåŠŸæç¤º
                            alert('è®¾ç½®å·²ä¿å­˜');
                            
                            // å…³é—­æ¨¡æ€æ¡†
                            settingsModal.classList.add('hidden');
                            settingsModal.classList.remove('flex');
                        }
                    });
                }
                
                // åˆå§‹åŒ–æ•°æ®
                if (initSystemBtn) {
                    initSystemBtn.addEventListener('click', function() {
                        if (confirm('ç¡®å®šè¦åˆå§‹åŒ–æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                            // æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨æ•°æ®
                            localStorage.removeItem('schedules');
                            localStorage.removeItem('gameData');
                            
                            // é‡æ–°åŠ è½½é¡µé¢
                            location.reload();
                        }
                    });
                }
                
                // å¤´åƒä¸Šä¼ å¤„ç†
                if (avatarUpload) {
                    avatarUpload.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (!file) return;
                        
                        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                        if (!file.type.startsWith('image/')) {
                            alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                            return;
                        }
                        
                        // è¯»å–æ–‡ä»¶
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            if (typeof gameData !== 'undefined') {
                                gameData.userInfo = gameData.userInfo || {};
                                gameData.userInfo.avatar = e.target.result;
                                
                                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                                localStorage.setItem('gameData', JSON.stringify(gameData));
                                
                                // æ›´æ–°æ˜¾ç¤º
                                const profileAvatar = document.querySelector('.profile-stats + .bg-indigo-600 .w-20');
                                if (profileAvatar) {
                                    profileAvatar.innerHTML = `<img src="${e.target.result}" alt="å¤´åƒ" class="w-full h-full rounded-full object-cover border-2 border-white/30 shadow-lg">`;
                                }
                                
                                // æ˜¾ç¤ºæˆåŠŸæç¤º
                                alert('å¤´åƒå·²æ›´æ–°');
                            }
                        };
                        reader.readAsDataURL(file);
                    });
                }
            }
        });
    </script>
    
    <!-- æ³¨å†ŒService Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then((registration) => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
